# 系统功能说明

## 新增功能

### 1. 定时任务管理

系统现在支持创建和管理定时搜索任务，用户可以设置不同的执行频率：

#### 支持的调度类型：
- **间隔执行**: 每隔指定分钟数执行一次
- **每日执行**: 每天在指定时间执行
- **每周执行**: 每周在指定日期和时间执行
- **每月执行**: 每月在指定日期和时间执行

#### 定时任务特性：
- 异步执行，不会阻塞主进程
- 自动计算下次执行时间
- 支持启用/禁用定时任务
- 完整的执行历史记录
- 执行结果持久化存储

### 2. 数据库持久化

系统使用SQLite数据库替代了原来的内存存储，提供以下优势：

#### 数据库表结构：
- **tasks**: 存储搜索任务信息
- **scheduled_tasks**: 存储定时任务配置
- **execution_results**: 存储任务执行结果
- **scheduled_execution_results**: 存储定时任务执行结果
- **video_info**: 存储视频详细信息
- **video_execution_results**: 存储视频与执行结果的关联

#### 持久化优势：
- 数据不会因服务重启而丢失
- 支持历史数据查询和分析
- 更好的数据一致性和可靠性
- 支持复杂的数据关联查询

## 使用方法

### 创建定时任务

1. 首先创建一个搜索任务
2. 点击"创建定时任务"按钮
3. 选择要定时执行的任务
4. 选择调度类型（间隔/每日/每周/每月）
5. 配置相应的参数
6. 点击"创建"完成

### 管理定时任务

- **查看详情**: 点击"查看"按钮查看任务详情和执行历史
- **启用/禁用**: 点击"启用"或"禁用"按钮切换任务状态
- **删除**: 点击"删除"按钮删除定时任务

### 查看执行结果

每个定时任务都提供完整的执行历史：
- 执行状态（成功/失败）
- 执行时间（开始/完成）
- 搜索结果数量
- 错误信息（如果有）

## 技术实现

### 后端架构

- **数据库层**: SQLAlchemy ORM + SQLite
- **任务调度**: 基于schedule库的定时任务调度器
- **异步执行**: 多线程调度器，不阻塞主进程
- **API接口**: RESTful API设计

### 前端界面

- **响应式设计**: 基于Bootstrap 5的现代化UI
- **实时更新**: 支持任务状态实时刷新
- **模态框管理**: 使用Bootstrap模态框展示详细信息
- **表单验证**: 完整的客户端表单验证

## 配置说明

### 环境变量

- `SCHEDULER_ENABLED`: 是否启用定时任务调度器（默认: true）
- `DATABASE_PATH`: 数据库文件路径（默认: ./video_search.db）

### 依赖包

新增的依赖包：
- `SQLAlchemy==2.0.23`: 数据库ORM框架
- `schedule==1.2.0`: 定时任务调度库

## 启动说明

### 首次运行

1. 安装依赖：`pip install -r requirements.txt`
2. 初始化数据库：`python init_database.py`
3. 启动服务：`python run.py`

### 正常启动

直接运行：`python run.py`

系统会自动：
- 初始化数据库（如果不存在）
- 启动定时任务调度器
- 加载已存在的定时任务
- 启动Web服务器

## 注意事项

1. **数据库文件**: 数据库文件会在首次运行时自动创建
2. **定时任务**: 服务重启后会自动恢复所有启用的定时任务
3. **执行历史**: 所有执行结果都会保存到数据库中
4. **资源管理**: 定时任务调度器使用守护线程，不会阻止主进程退出

## 故障排除

### 常见问题

1. **数据库连接失败**: 检查数据库文件权限和路径
2. **定时任务不执行**: 检查调度器是否正常启动
3. **执行结果丢失**: 检查数据库连接和事务提交

### 日志查看

系统会在控制台输出详细的运行日志，包括：
- 数据库初始化状态
- 定时任务调度器状态
- 任务执行结果
- 错误信息
